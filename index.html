<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>FitTrack Pro - Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --success: #06d6a0;
      --danger: #ef4444;
      --light: #f8f9fa;
      --dark: #212529;
      --bg: #f0f4f8;
      --card: #ffffff;
    }
    [data-theme="dark"] {
      --bg: #0f172a;
      --card: #1e293b;
      --light: #0f172a;
      --dark: #f1f5f9;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
    body {
      background-color: var(--bg);
      color: var(--dark);
      direction: rtl;
      transition: background-color 0.3s, color 0.3s;
    }
    .top-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--card);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 0 15px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 1000;
    }
    .nav-icons {
      display: flex;
      gap: 28px;
    }
    .nav-icon {
      font-size: 1.4rem;
      color: #94a3b8;
      cursor: pointer;
      transition: color 0.2s;
    }
    .nav-icon.active, .nav-icon:hover {
      color: var(--primary);
    }
    .logo-icon {
      font-size: 1.8rem;
      color: var(--primary);
    }
    #appSection {
      padding-top: 70px;
      padding-bottom: 20px;
    }
    .container { max-width: 480px; margin: 0 auto; padding: 0 15px; }
    .section {
      background: var(--card);
      padding: 22px;
      border-radius: 18px;
      margin-bottom: 22px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    .hidden { display: none; }
    h2 {
      font-size: 22px;
      margin-bottom: 20px;
      color: var(--primary);
      text-align: center;
    }
    .metric {
      font-size: 26px;
      font-weight: bold;
      margin: 10px 0;
      color: var(--primary);
    }
    .label {
      color: #64748b;
      font-size: 15px;
      margin-bottom: 4px;
      display: block;
    }
    .coord {
      font-family: monospace;
      background: #f1f8ff;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0;
      direction: ltr;
      text-align: center;
      font-size: 15px;
      border: 1px solid #dbeafe;
    }
    .gps-status {
      padding: 10px;
      border-radius: 10px;
      margin: 12px 0;
      text-align: center;
      background: #f0f9ff;
      color: #0c4a6e;
      font-weight: bold;
    }
    [data-theme="dark"] .gps-status {
      background: #1e293b;
      color: #94a3b8;
    }
    .btn {
      width: 100%;
      padding: 14px;
      font-size: 18px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
    }
    .btn-start { background: #10b981; color: white; }
    .btn-stop { background: #ef4444; color: white; }
    .btn:disabled { opacity: 0.6; }
    input, select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      background: var(--card);
      color: var(--dark);
    }
    #preAuthSection {
      max-width: 400px;
      margin: 60px auto;
      padding: 30px;
      background: var(--card);
      border-radius: 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
      text-align: center;
    }
    .app-logo { font-size: 3.5rem; color: var(--primary); margin-bottom: 20px; }
    .app-title { font-size: 1.8rem; font-weight: 800; color: var(--primary); margin-bottom: 25px; }
    .auth-buttons { display: flex; gap: 12px; margin-top: 10px; }
    .auth-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1rem;
    }
    .signup-btn { background: var(--primary); color: white; }
    .login-btn { background: #6c757d; color: white; }
    .progress-bar {
      height: 10px;
      background: #e2e8f0;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    [data-theme="dark"] .progress-bar { background: #334155; }
    .progress-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 5px;
      transition: width 0.5s;
    }
    #map { height: 250px; border-radius: 12px; margin: 15px 0; }
    .share-btn {
      background: #3b82f6;
      margin-top: 15px;
    }
    .theme-toggle {
      position: absolute;
      right: 15px;
      top: 15px;
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 1.2rem;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      .auth-buttons { flex-direction: column; }
      .nav-icons { gap: 20px; }
    }
  </style>
  <!-- PWA Manifest -->
  <link rel="manifest" href="#"/>
  <script>
    // PWA Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(console.error);
      });
    }
  </script>
</head>
<body>
  <!-- Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ -->
  <button class="theme-toggle" id="themeToggle">
    <i class="fas fa-moon"></i>
  </button>

  <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="preAuthSection">
    <div class="app-logo"><i class="fas fa-dumbbell"></i></div>
    <h1 class="app-title">FitTrack Pro</h1>
    <div class="input-group">
      <input type="text" id="usernameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
      <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    </div>
    <div class="auth-buttons">
      <button class="auth-btn signup-btn" onclick="handleAuth(true)">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
      <button class="auth-btn login-btn" onclick="handleAuth(false)">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
  <nav id="topNav" class="top-nav hidden">
    <div class="nav-icons">
      <i class="nav-icon fas fa-home active" data-tab="dashboard"></i>
      <i class="nav-icon fas fa-running" data-tab="workouts"></i>
      <i class="nav-icon fas fa-utensils" data-tab="nutrition"></i>
      <i class="nav-icon fas fa-cog" data-tab="profile"></i>
    </div>
    <div class="logo-icon"><i class="fas fa-dumbbell"></i></div>
  </nav>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
  <div id="appSection" class="hidden">
    <div class="container">
      <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
      <div id="dashboardTab" class="tab-content">
        <div class="section">
          <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ©</h2>
          
          <!-- Ø£Ù‡Ø¯Ø§Ù -->
          <div style="margin: 15px 0;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span>Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù…Ù† Ø§Ù„Ø®Ø·ÙˆØ§Øª</span>
              <span id="stepProgressText">0/10000</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="stepProgressBar" style="width: 0%;"></div>
            </div>
          </div>
          
          <div style="margin: 15px 0;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span>Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ©</span>
              <span id="distanceProgressText">0/35 ÙƒÙ…</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="distanceProgressBar" style="width: 0%;"></div>
            </div>
          </div>
          
          <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
          <canvas id="stepsChart" height="150"></canvas>
          <canvas id="distanceChart" height="150" style="margin-top: 20px;"></canvas>
          
          <!-- Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© -->
          <button class="btn share-btn" onclick="shareAchievement()">
            <i class="fas fa-share-alt"></i> Ù…Ø´Ø§Ø±ÙƒØ© Ø¥Ù†Ø¬Ø§Ø²ÙŠ
          </button>
        </div>
      </div>

      <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ† -->
      <div id="workoutsTab" class="tab-content hidden">
        <div class="section">
          <h2>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù‡Ø¬ÙŠÙ†</h2>
          
          <div class="label">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø©</div>
          <div class="metric" id="distance">0.00 Ù…</div>

          <div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø·ÙˆØ§Øª</div>
          <div class="metric" id="steps">0</div>

          <div class="label">ÙˆØ¶Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù…</div>
          <div id="mode" class="gps-status">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡</div>

          <div class="label">Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶</div>
          <div class="coord" id="lat">â€”</div>

          <div class="label">Ø®Ø· Ø§Ù„Ø·ÙˆÙ„</div>
          <div class="coord" id="lng">â€”</div>

          <div id="gpsStatus" class="gps-status">Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØªØ¨Ø¹" Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¬ÙŠÙ†</div>

          <!-- Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø³Ø§Ø± -->
          <div id="map"></div>

          <button id="startBtn" class="btn btn-start">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØªØ¨Ø¹</button>
          <button id="stopBtn" class="btn btn-stop" disabled>Ø¥ÙŠÙ‚Ø§Ù</button>
        </div>
      </div>

      <!-- Ø§Ù„ØªØºØ°ÙŠØ© -->
      <div id="nutritionTab" class="tab-content hidden">
        <div class="section">
          <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</h2>
          <select id="mealType">
            <option value="breakfast">ÙØ·ÙˆØ±</option>
            <option value="lunch">ØºØ¯Ø§Ø¡</option>
            <option value="dinner">Ø¹Ø´Ø§Ø¡</option>
            <option value="snack">ÙˆØ¬Ø¨Ø© Ø®ÙÙŠÙØ©</option>
          </select>
          <input type="text" id="foodItem" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø¹Ø§Ù…" />
          <input type="number" id="caloriesInput" placeholder="Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©" min="0" />
          <button class="btn" onclick="saveNutrition()">Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø©</button>
          <div id="nutritionList" style="margin-top:20px;"></div>
        </div>
      </div>

      <!-- Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
      <div id="profileTab" class="tab-content hidden">
        <div class="section">
          <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØªØ®ØµÙŠØµ</h2>
          
          <label>Ø§Ù„Ø§Ø³Ù…</label>
          <input type="text" id="displayNameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶" />
          
          <label>Ø§Ù„ÙˆØ²Ù† (ÙƒØº)</label>
          <input type="number" id="weightInput" min="30" max="200" step="0.1" />
          
          <label>Ø·ÙˆÙ„ Ø§Ù„Ø®Ø·ÙˆØ© (Ù…)</label>
          <input type="number" id="stepLengthInput" min="0.3" max="1.2" step="0.01" placeholder="0.75" />
          
          <label>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©</label>
          <select id="unitPreference">
            <option value="km">ÙƒÙŠÙ„ÙˆÙ…ØªØ±</option>
            <option value="mile">Ù…ÙŠÙ„</option>
          </select>
          
          <label>Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù…Ù† Ø§Ù„Ø®Ø·ÙˆØ§Øª</label>
          <input type="number" id="stepGoalInput" min="1000" max="50000" placeholder="10000" />
          
          <label>Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)</label>
          <input type="number" id="weeklyDistanceGoal" min="5" max="100" placeholder="35" />
          
          <button class="btn" onclick="saveSettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
          <button class="btn" style="background:#64748b; margin-top:20px;" onclick="exportAllData()">ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          <button class="btn" style="background:#ef4444; margin-top:10px;" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ===
    let currentLang = 'ar';
    let currentUser = null;
    let workoutActive = false;
    let totalDistance = 0;
    let stepCount = 0;
    let lastGpsPosition = null;
    let lastGpsTime = 0;
    let lastAccel = 0;
    let lastStepTime = 0;
    let isGpsAvailable = false;
    let gpsTimeout = 0;
    let positions = [];
    let map = null;
    let polyline = null;
    let stepsChart = null;
    let distanceChart = null;

    // === Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ===
    let settings = {
      weight: 75,
      stepLength: 0.75,
      unit: 'km',
      stepGoal: 10000,
      weeklyDistanceGoal: 35
    };

    // === Firebase ===
    const firebaseConfig = {
      apiKey: "AIzaSyC1ps0XFVjJJ1YAi2H0XEtjAc-wslWrNjo",
      authDomain: "ddccdc-c6a58.firebaseapp.com",
      projectId: "ddccdc-c6a58",
      storageBucket: "ddccdc-c6a58.firebasestorage.app",
      messagingSenderId: "339966933373",
      appId: "1:339966933373:web:b638ece3460e6c7a7c7414"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // === Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ===
    const distanceEl = document.getElementById('distance');
    const stepsEl = document.getElementById('steps');
    const latEl = document.getElementById('lat');
    const lngEl = document.getElementById('lng');
    const modeEl = document.getElementById('mode');
    const gpsStatusEl = document.getElementById('gpsStatus');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const themeToggle = document.getElementById('themeToggle');

    // === Ø§Ù„Ø«ÙˆØ§Ø¨Øª ===
    const STEP_THRESHOLD = 1.7;
    const MIN_STEP_INTERVAL = 400;
    const GPS_TIMEOUT_MS = 5000;

    // === ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© ===
    function initMap() {
      if (!map) {
        map = L.map('map').setView([33.234567, 44.123456], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap'
        }).addTo(map);
        polyline = L.polyline([], {color: '#4361ee'}).addTo(map);
      }
    }

    // === Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¬ÙŠÙ† Ù„Ù„ØªÙ…Ø§Ø±ÙŠÙ† ===
    function handleMotion(event) {
      if (!workoutActive) return;
      const acc = event.accelerationIncludingGravity;
      if (!acc) return;

      const now = Date.now();
      const accel = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
      const delta = Math.abs(accel - lastAccel);
      lastAccel = accel;

      if (delta > STEP_THRESHOLD && (now - lastStepTime) > MIN_STEP_INTERVAL) {
        stepCount++;
        stepsEl.textContent = stepCount;
        totalDistance += settings.stepLength;
        updateDistanceDisplay();
        lastStepTime = now;

        if (!isGpsAvailable || (now - lastGpsTime) > GPS_TIMEOUT_MS) {
          modeEl.textContent = 'ğŸš¶ ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§Ø®ÙÙ„ (PDR)';
          modeEl.style.color = '#ea580c';
          modeEl.style.background = '#ffedd5';
        }
      }
    }

    function updateGps() {
      if (!workoutActive) return;
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          const now = Date.now();
          latEl.textContent = latitude.toFixed(7);
          lngEl.textContent = longitude.toFixed(7);
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø©
          if (map) {
            map.setView([latitude, longitude], 15);
            positions.push([latitude, longitude]);
            polyline.setLatLngs(positions);
            if (positions.length === 1) map.fitBounds(polyline.getBounds());
          }
          
          if (lastGpsPosition) {
            const d = haversineDistance(lastGpsPosition[0], lastGpsPosition[1], latitude, longitude);
            totalDistance += d * 1000; // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø£Ù…ØªØ§Ø±
            updateDistanceDisplay();
          }
          lastGpsPosition = [latitude, longitude];
          lastGpsTime = now;
          isGpsAvailable = true;
          gpsTimeout = 0;
          modeEl.textContent = 'ğŸ›°ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ø®Ø§Ø±ÙØ¬ (GPS + PDR)';
          modeEl.style.color = '#1d4ed8';
          modeEl.style.background = '#dbeafe';
          gpsStatusEl.textContent = `Ø¯Ù‚Ø© GPS: ${accuracy.toFixed(1)} Ù…`;
        },
        (error) => {
          isGpsAvailable = false;
          gpsTimeout += 2000;
          if (gpsTimeout > GPS_TIMEOUT_MS) {
            modeEl.textContent = 'ğŸš¶ ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§Ø®ÙÙ„ (PDR ÙÙ‚Ø·)';
            modeEl.style.color = '#ea580c';
            modeEl.style.background = '#ffedd5';
          }
        },
        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
      );
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function updateDistanceDisplay() {
      if (settings.unit === 'mile') {
        const miles = totalDistance / 1609.34;
        distanceEl.textContent = miles >= 1 ? miles.toFixed(2) + ' Ù…ÙŠÙ„' : (miles * 1000).toFixed(1) + ' Ù‚Ø¯Ù…';
      } else {
        distanceEl.textContent = totalDistance >= 1000 
          ? (totalDistance / 1000).toFixed(3) + ' ÙƒÙ…' 
          : totalDistance.toFixed(1) + ' Ù…';
      }
    }

    function startWorkout() {
      if (!navigator.geolocation) {
        gpsStatusEl.textContent = 'âŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…';
        return;
      }
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission().then(permission => {
          if (permission === 'granted') initWorkout();
          else gpsStatusEl.textContent = 'âŒ Ø±ÙÙØ¶ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø³Ø§Ø³';
        });
      } else {
        initWorkout();
      }
    }

    function initWorkout() {
      workoutActive = true;
      totalDistance = 0;
      stepCount = 0;
      lastGpsPosition = null;
      isGpsAvailable = false;
      gpsTimeout = 0;
      positions = [];

      distanceEl.textContent = '0.00 Ù…';
      stepsEl.textContent = '0';
      latEl.textContent = 'â€”';
      lngEl.textContent = 'â€”';
      modeEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙØ¹ÙŠÙ„...';
      gpsStatusEl.textContent = 'âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ù†Ø´Ø· â€” ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø¯Ø§Ø®Ù„ ÙˆØ§Ù„Ø®Ø§Ø±Ø¬';

      startBtn.disabled = true;
      stopBtn.disabled = false;

      // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
      initMap();
      map.invalidateSize();

      window.addEventListener('devicemotion', handleMotion);
      updateGps();
      setInterval(updateGps, 2000);
    }

    function stopWorkout() {
      workoutActive = false;
      window.removeEventListener('devicemotion', handleMotion);
      startBtn.disabled = false;
      stopBtn.disabled = true;

      const finalDistanceKm = totalDistance / 1000;
      const calories = Math.round(finalDistanceKm * settings.weight * 0.78);

      db.collection('users').doc(currentUser.uid).collection('workouts').add({
        type: 'walking',
        distance: parseFloat(finalDistanceKm.toFixed(3)),
        calories,
        steps: stepCount,
        date: new Date().toISOString().split('T')[0],
        positions,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        gpsStatusEl.textContent = `â¹ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸: ${stepCount} Ø®Ø·ÙˆØ© | ${totalDistance >= 1000 ? (totalDistance/1000).toFixed(3) : totalDistance.toFixed(1)} ${settings.unit === 'mile' ? 'Ù…ÙŠÙ„' : 'ÙƒÙ…'}`;
        loadDashboard();
      });
    }

    // === Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ===
    function loadDashboard() {
      const today = new Date().toISOString().split('T')[0];
      const weekStart = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      
      db.collection('users').doc(currentUser.uid).collection('workouts')
        .where('date', '>=', weekStart)
        .get()
        .then(snapshot => {
          let weeklySteps = 0;
          let weeklyDistance = 0;
          let todaySteps = 0;
          let todayDistance = 0;
          
          snapshot.forEach(doc => {
            const w = doc.data();
            weeklySteps += w.steps || 0;
            weeklyDistance += w.distance || 0;
            if (w.date === today) {
              todaySteps += w.steps || 0;
              todayDistance += w.distance || 0;
            }
          });
          
          // ØªØ­Ø¯ÙŠØ« Ø£Ù‡Ø¯Ø§Ù Ø§Ù„ÙŠÙˆÙ…
          updateStepProgress(todaySteps, settings.stepGoal);
          updateDistanceProgress(todayDistance, settings.weeklyDistanceGoal / 7);
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
          updateCharts(snapshot);
        });
    }

    function updateStepProgress(steps, goal) {
      const percent = Math.min(100, (steps / goal) * 100);
      document.getElementById('stepProgressBar').style.width = `${percent}%`;
      document.getElementById('stepProgressText').innerText = `${steps}/${goal}`;
    }

    function updateDistanceProgress(distance, dailyGoal) {
      const percent = Math.min(100, (distance / dailyGoal) * 100);
      document.getElementById('distanceProgressBar').style.width = `${percent}%`;
      document.getElementById('distanceProgressText').innerText = `${distance.toFixed(1)}/${dailyGoal} ÙƒÙ…`;
    }

    function updateCharts(snapshot) {
      const labels = [];
      const stepsData = [];
      const distanceData = [];
      
      // Ø¥Ù†Ø´Ø§Ø¡ ØªØ³Ù…ÙŠØ§Øª Ù„Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø¨Ø¹Ø© Ø§Ù„Ù…Ø§Ø¶ÙŠØ©
      for (let i = 6; i >= 0; i--) {
        const d = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
        labels.push(d.toLocaleDateString('ar-EG', { weekday: 'short' }));
        stepsData.push(0);
        distanceData.push(0);
      }
      
      // Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      snapshot.forEach(doc => {
        const w = doc.data();
        const date = new Date(w.date);
        const daysAgo = Math.floor((Date.now() - date.getTime()) / (24 * 60 * 60 * 1000));
        if (daysAgo >= 0 && daysAgo <= 6) {
          stepsData[6 - daysAgo] += w.steps || 0;
          distanceData[6 - daysAgo] += w.distance || 0;
        }
      });
      
      // Ø±Ø³Ù… Ø±Ø³Ù… Ø§Ù„Ø®Ø·ÙˆØ§Øª
      const ctx1 = document.getElementById('stepsChart').getContext('2d');
      if (stepsChart) stepsChart.destroy();
      stepsChart = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©',
            data: stepsData,
            backgroundColor: 'rgba(67, 97, 238, 0.6)'
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
      
      // Ø±Ø³Ù… Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§ÙØ©
      const ctx2 = document.getElementById('distanceChart').getContext('2d');
      if (distanceChart) distanceChart.destroy();
      distanceChart = new Chart(ctx2, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (ÙƒÙ…)',
            data: distanceData,
            borderColor: '#10b981',
            tension: 0.4
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // === Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===
    function saveSettings() {
      const displayName = document.getElementById('displayNameInput').value.trim() || currentUser.displayName;
      const weight = parseFloat(document.getElementById('weightInput').value) || 75;
      const stepLength = parseFloat(document.getElementById('stepLengthInput').value) || 0.75;
      const unit = document.getElementById('unitPreference').value;
      const stepGoal = parseInt(document.getElementById('stepGoalInput').value) || 10000;
      const weeklyDistanceGoal = parseInt(document.getElementById('weeklyDistanceGoal').value) || 35;
      
      settings = { weight, stepLength, unit, stepGoal, weeklyDistanceGoal };
      
      db.collection('users').doc(currentUser.uid).set({
        displayName,
        weight,
        stepLength,
        unit,
        stepGoal,
        weeklyDistanceGoal,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true })
      .then(() => {
        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
        currentUser.updateProfile({ displayName });
        loadDashboard();
      });
    }

    function loadSettings() {
      db.collection('users').doc(currentUser.uid).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          settings.weight = data.weight || 75;
          settings.stepLength = data.stepLength || 0.75;
          settings.unit = data.unit || 'km';
          settings.stepGoal = data.stepGoal || 10000;
          settings.weeklyDistanceGoal = data.weeklyDistanceGoal || 35;
          
          document.getElementById('displayNameInput').value = data.displayName || '';
          document.getElementById('weightInput').value = settings.weight;
          document.getElementById('stepLengthInput').value = settings.stepLength;
          document.getElementById('unitPreference').value = settings.unit;
          document.getElementById('stepGoalInput').value = settings.stepGoal;
          document.getElementById('weeklyDistanceGoal').value = settings.weeklyDistanceGoal;
        }
      });
    }

    // === ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¶Ø§ÙÙŠØ© ===
    function shareAchievement() {
      const message = `Ù„Ù‚Ø¯ Ø­Ù‚Ù‚Øª ${stepCount} Ø®Ø·ÙˆØ© Ø§Ù„ÙŠÙˆÙ… Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚ FitTrack Pro! ğŸ’ª`;
      if (navigator.share) {
        navigator.share({ text: message }).catch(console.error);
      } else {
        navigator.clipboard.writeText(message).then(() => {
          alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©!');
        });
      }
    }

    function exportAllData() {
      db.collection('users').doc(currentUser.uid).collection('workouts').get()
        .then(snapshot => {
          let csv = 'Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…),Ø§Ù„Ø®Ø·ÙˆØ§Øª,Ø§Ù„Ø³Ø¹Ø±Ø§Øª\n';
          snapshot.forEach(doc => {
            const w = doc.data();
            csv += `${w.date},${w.distance},${w.steps},${w.calories}\n`;
          });
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'fittrack-data.csv';
          a.click();
          URL.revokeObjectURL(url);
        });
    }

    function toggleTheme() {
      const isDark = document.body.getAttribute('data-theme') === 'dark';
      document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
      themeToggle.innerHTML = isDark ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }

    // === Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ===
    function initApp() {
      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸
      const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.body.setAttribute('data-theme', savedTheme);
      themeToggle.innerHTML = savedTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
      
      // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
      startBtn.addEventListener('click', startWorkout);
      stopBtn.addEventListener('click', stopWorkout);
      themeToggle.addEventListener('click', toggleTheme);
      
      // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªÙ†Ù‚Ù„
      document.querySelectorAll('.nav-icon').forEach(icon => {
        icon.addEventListener('click', () => {
          document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
          document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
          const tab = icon.getAttribute('data-tab');
          document.getElementById(tab + 'Tab').classList.remove('hidden');
          icon.classList.add('active');
          
          if (tab === 'dashboard' && currentUser) loadDashboard();
          if (tab === 'profile' && currentUser) loadSettings();
          if (tab === 'workouts') initMap();
        });
      });
    }

    // === Auth ===
    function handleAuth(isSignup) {
      const username = document.getElementById('usernameInput').value.trim();
      const password = document.getElementById('passwordInput').value;
      if (!username || password.length < 6) return alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø© (6 Ø£Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰)');
      const email = `${username}@example.com`;
      (isSignup ? auth.createUserWithEmailAndPassword(email, password) : auth.signInWithEmailAndPassword(email, password))
        .then(async (userCredential) => {
          if (isSignup) {
            await userCredential.user.updateProfile({ displayName: username });
            await db.collection('users').doc(userCredential.user.uid).set({ displayName: username });
          }
          currentUser = userCredential.user;
          document.getElementById('preAuthSection').classList.add('hidden');
          document.getElementById('topNav').classList.remove('hidden');
          document.getElementById('appSection').classList.remove('hidden');
          loadSettings();
          document.querySelector('.nav-icon[data-tab="dashboard"]').click();
        })
        .catch(err => alert('Ø®Ø·Ø£: ' + err.message));
    }

    function logout() {
      auth.signOut().then(() => {
        currentUser = null;
        document.getElementById('preAuthSection').classList.remove('hidden');
        document.getElementById('topNav').classList.add('hidden');
        document.getElementById('appSection').classList.add('hidden');
      });
    }

    // === Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ===
    window.addEventListener('load', initApp);
  </script>
</body>
</html>
