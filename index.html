<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>FitTrack Pro</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
--primary: #4361ee;
--success: #06d6a0;
--danger: #ef4444;
--light: #f8f9fa;
--dark: #212529;
--bg: #f0f4f8;
--card: #ffffff;
}
[data-theme="dark"] {
--bg: #0f172a;
--card: #1e293b;
--light: #0f172a;
--dark: #f1f5f9;
}
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
body {
background-color: var(--bg);
color: var(--dark);
direction: rtl;
transition: background-color 0.3s, color 0.3s;
}
body.en { direction: ltr; text-align: left; }
/* ========== BEFORE LOGIN ========== */
#preAuthSection {
max-width: 400px;
margin: 60px auto;
padding: 30px;
background: var(--card);
border-radius: 20px;
box-shadow: 0 8px 24px rgba(0,0,0,0.1);
text-align: center;
}
.app-logo {
font-size: 3.5rem;
color: var(--primary);
margin-bottom: 20px;
}
.app-title {
font-size: 1.8rem;
font-weight: 800;
color: var(--primary);
margin-bottom: 25px;
}
.input-group {
margin-bottom: 20px;
text-align: right;
}
.input-group.en { text-align: left; }
.input-group input {
width: 100%;
padding: 14px;
border: 1px solid #4b5563;
border-radius: 12px;
font-size: 1rem;
background: var(--card);
color: var(--dark);
}
.auth-buttons {
display: flex;
gap: 12px;
margin-top: 10px;
}
.auth-btn {
flex: 1;
padding: 12px;
border: none;
border-radius: 12px;
font-weight: bold;
cursor: pointer;
font-size: 1rem;
}
.signup-btn { background: var(--primary); color: white; }
.login-btn { background: #6c757d; color: white; }
.auth-btn:hover { opacity: 0.9; }
/* ========== AFTER LOGIN ========== */
.top-nav {
position: fixed;
top: 0;
left: 0;
right: 0;
background: var(--card);
box-shadow: 0 2px 10px rgba(0,0,0,0.1);
padding: 0 15px;
height: 60px;
display: flex;
align-items: center;
justify-content: space-between;
z-index: 1000;
}
.nav-icons {
display: flex;
gap: 28px;
}
.nav-icon {
font-size: 1.4rem;
color: #94a3b8;
cursor: pointer;
transition: color 0.2s;
}
.nav-icon.active, .nav-icon:hover {
color: var(--primary);
}
.logo-icon {
font-size: 1.8rem;
color: var(--primary);
}
#appSection {
padding-top: 70px;
padding-bottom: 20px;
}
.container { max-width: 100%; padding: 0 15px; }
.section {
background: var(--card);
padding: 22px;
border-radius: 18px;
margin-bottom: 22px;
box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}
.hidden { display: none; }
label { display: block; margin: 14px 0 8px; font-weight: 600; }
input, select, button {
width: 100%;
padding: 13px;
margin-bottom: 18px;
border: 1px solid #4b5563;
border-radius: 12px;
font-size: 1rem;
background: var(--card);
color: var(--dark);
}
button {
background: var(--primary);
color: white;
font-weight: bold;
border: none;
cursor: pointer;
}
.stats-grid {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 16px;
margin: 20px 0;
}
.stat-card {
background: #f8fafc;
padding: 16px;
border-radius: 14px;
text-align: center;
}
[data-theme="dark"] .stat-card { background: #334155; }
.stat-value { font-size: 1.4rem; font-weight: bold; color: var(--primary); }
.stat-label { font-size: 0.85rem; color: #64748b; margin-top: 4px; }
[data-theme="dark"] .stat-label { color: #cbd5e1; }
canvas { max-height: 250px; margin-top: 20px; }
.gps-status {
text-align: center;
padding: 10px;
background: #e2e8f0;
border-radius: 10px;
margin: 15px 0;
font-size: 0.9rem;
}
[data-theme="dark"] .gps-status { background: #334155; color: #f1f5f9; }
.logout-btn {
background: var(--danger);
width: auto;
padding: 10px 20px;
margin-top: 10px;
}
.progress-bar {
height: 10px;
background: #e2e8f0;
border-radius: 5px;
margin: 10px 0;
overflow: hidden;
}
[data-theme="dark"] .progress-bar { background: #334155; }
.progress-fill {
height: 100%;
background: var(--primary);
border-radius: 5px;
transition: width 0.5s;
}
.calendar-grid {
display: grid;
grid-template-columns: repeat(7, 1fr);
gap: 4px;
margin: 15px 0;
}
.calendar-day {
width: 36px;
height: 36px;
display: flex;
align-items: center;
justify-content: center;
font-size: 0.8rem;
border-radius: 50%;
}
.calendar-day.active { background: var(--primary); color: white; }
.calendar-day.inactive { background: #e2e8f0; }
[data-theme="dark"] .calendar-day.inactive { background: #334155; color: #cbd5e1; }
.export-btn {
background: #06d6a0;
margin-top: 15px;
}
@media (max-width: 600px) {
.auth-buttons { flex-direction: column; }
.nav-icons { gap: 20px; }
.nav-icon { font-size: 1.25rem; }
.stats-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body class="ar">
<!-- ========== BEFORE LOGIN ========== -->
<div id="preAuthSection">
<div class="app-logo">
<i class="fas fa-dumbbell"></i>
</div>
<h1 class="app-title">FitTrack Pro</h1>
<div class="input-group" id="inputGroup">
<input type="text" id="usernameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
<input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
</div>
<div class="auth-buttons">
<button class="auth-btn signup-btn" onclick="handleAuth(true)">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
<button class="auth-btn login-btn" onclick="handleAuth(false)">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
</div>
</div>
<!-- ========== AFTER LOGIN ========== -->
<nav id="topNav" class="top-nav hidden">
<div class="nav-icons">
<i class="nav-icon fas fa-home active" data-tab="dashboard"></i>
<i class="nav-icon fas fa-running" data-tab="workouts"></i>
<i class="nav-icon fas fa-utensils" data-tab="nutrition"></i>
<i class="nav-icon fas fa-cog" data-tab="profile"></i>
</div>
<div class="logo-icon">
<i class="fas fa-dumbbell"></i>
</div>
</nav>
<div id="appSection" class="hidden">
<div class="container">
<!-- Dashboard Tab -->
<div id="dashboardTab" class="tab-content">
<div class="section">
<h2 id="dashboardTitle">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ©</h2>
<!-- Ù‡Ø¯Ù Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠ -->
<div style="margin: 20px 0;">
<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
<span id="calorieGoalLabel">Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù…Ù† Ø§Ù„Ø³Ø¹Ø±Ø§Øª</span>
<span id="calorieProgressText">0/2000</span>
</div>
<div class="progress-bar">
<div class="progress-fill" id="calorieProgressBar" style="width: 0%;"></div>
</div>
</div>
<div class="stats-grid">
<div class="stat-card">
<div class="stat-value" id="caloriesBurned">0</div>
<div class="stat-label" id="caloriesBurnedLabel">Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø±ÙˆÙ‚Ø©</div>
</div>
<div class="stat-card">
<div class="stat-value" id="caloriesConsumed">0</div>
<div class="stat-label" id="caloriesConsumedLabel">Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©</div>
</div>
<div class="stat-card">
<div class="stat-value" id="netCalories">0</div>
<div class="stat-label" id="netCaloriesLabel">Ø§Ù„Ø±ØµÙŠØ¯ (Ø§Ù„Ù…Ø­Ø±ÙˆÙ‚Ø© - Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©)</div>
</div>
<div class="stat-card">
<div class="stat-value" id="daysGoalMet">0/7</div>
<div class="stat-label" id="daysGoalMetLabel">Ø£ÙŠØ§Ù… ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù (Ø£Ø³Ø¨ÙˆØ¹ÙŠ)</div>
</div>
</div>
<!-- ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù†Ø´Ø§Ø· -->
<h3 style="margin: 20px 0;">ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù†Ø´Ø§Ø· (Ø¢Ø®Ø± 14 ÙŠÙˆÙ…Ù‹Ø§)</h3>
<div class="calendar-grid" id="activityCalendar"></div>
<h3 style="margin: 20px 0;">Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h3>
<canvas id="weeklyChart"></canvas>
<!-- Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± -->
<button class="export-btn" onclick="exportData()">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (CSV)</button>
</div>
</div>
<!-- Workouts Tab -->
<div id="workoutsTab" class="tab-content hidden">
<div class="section">
<h2 id="workoutsTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</h2>
<select id="activityType" onchange="onActivityChange()">
<option value="walking">Ù…Ø´ÙŠ</option>
<option value="running">Ø±ÙƒØ¶</option>
<option value="cycling">Ø±ÙƒÙˆØ¨ Ø¯Ø±Ø§Ø¬Ø©</option>
<option value="weights">Ø±ÙØ¹ Ø£Ø«Ù‚Ø§Ù„</option>
</select>
<div id="gpsSection" class="hidden">
<div class="gps-status" id="gpsStatus">Ø¬Ø§Ø±Ù ØªÙØ¹ÙŠÙ„ GPS ÙˆØ§Ù„Ø­Ø³Ø§Ø³...</div>
</div>
<div class="stats-grid">
<div class="stat-card">
<div class="stat-value" id="timeDisplay">00:00</div>
<div class="stat-label" id="timeLabel">Ø§Ù„ÙˆÙ‚Øª</div>
</div>
<div class="stat-card">
<div class="stat-value" id="distanceDisplay">0.0</div>
<div class="stat-label" id="distanceLabel">Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)</div>
</div>
<div class="stat-card">
<div class="stat-value" id="stepCountDisplay">0</div>
<div class="stat-label" id="stepCountLabel">Ø§Ù„Ø®Ø·ÙˆØ§Øª</div>
</div>
</div>
<button id="startBtn" onclick="startWorkout()">Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</button>
<button id="stopBtn" class="danger hidden" onclick="stopWorkout()">Ø¥Ù†Ù‡Ø§Ø¡</button>
</div>
</div>
<!-- Nutrition Tab -->
<div id="nutritionTab" class="tab-content hidden">
<div class="section">
<h2 id="nutritionTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØºØ°ÙŠØ©</h2>
<label id="mealLabel">Ø§Ù„ÙˆØ¬Ø¨Ø©</label>
<select id="mealType">
<option value="breakfast">ÙØ·ÙˆØ±</option>
<option value="lunch">ØºØ¯Ø§Ø¡</option>
<option value="dinner">Ø¹Ø´Ø§Ø¡</option>
<option value="snack">ÙˆØ¬Ø¨Ø© Ø®ÙÙŠÙØ©</option>
</select>
<input type="text" id="foodItem" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø¹Ø§Ù…" />
<input type="number" id="caloriesInput" placeholder="Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©" min="0" />
<input type="number" id="proteinInput" placeholder="Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ† (Øº)" min="0" step="0.1" />
<input type="number" id="carbsInput" placeholder="Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª (Øº)" min="0" step="0.1" />
<input type="number" id="fatsInput" placeholder="Ø§Ù„Ø¯Ù‡ÙˆÙ† (Øº)" min="0" step="0.1" />
<button onclick="saveNutrition()">Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø©</button>
<div id="nutritionList" style="margin-top: 20px;"></div>
</div>
</div>
<!-- Profile Tab -->
<div id="profileTab" class="tab-content hidden">
<div class="section">
<h2 id="profileTitle">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h2>
<label id="ageLabel">Ø§Ù„Ø¹Ù…Ø±</label>
<input type="number" id="ageInput" min="10" max="100" />
<label id="weightLabel">Ø§Ù„ÙˆØ²Ù† (ÙƒØº)</label>
<input type="number" id="weightInput" min="30" max="200" step="0.1" />
<label id="heightLabel">Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</label>
<input type="number" id="heightInput" min="100" max="250" />
<label id="goalLabel">Ø§Ù„Ù‡Ø¯Ù</label>
<select id="goalInput">
<option value="lose">Ø¥Ù†Ù‚Ø§Øµ Ø§Ù„ÙˆØ²Ù†</option>
<option value="gain">Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¶Ù„Ø§Øª</option>
<option value="maintain">Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ²Ù†</option>
</select>
<label>Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</label>
<input type="number" id="calorieGoalInput" min="1000" max="5000" placeholder="2000" />
<button onclick="saveProfile()">Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
<div class="user-info" id="userInfo" style="margin: 15px 0; font-weight: 600;"></div>
<button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>
</div>
</div>
</div>
<script>
// --- Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª ---
const translations = {
ar: {
appTitle: "FitTrack Pro",
username: "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
password: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
signup: "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨",
login: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
dashboardTitle: "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ©",
caloriesBurned: "Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø±ÙˆÙ‚Ø©",
caloriesConsumed: "Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©",
netCalories: "Ø§Ù„Ø±ØµÙŠØ¯ (Ø§Ù„Ù…Ø­Ø±ÙˆÙ‚Ø© - Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©)",
daysGoalMet: "Ø£ÙŠØ§Ù… ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù (Ø£Ø³Ø¨ÙˆØ¹ÙŠ)",
workoutsTitle: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†",
nutritionTitle: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØºØ°ÙŠØ©",
profileTitle: "Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©",
walking: "Ù…Ø´ÙŠ",
running: "Ø±ÙƒØ¶",
cycling: "Ø±ÙƒÙˆØ¨ Ø¯Ø±Ø§Ø¬Ø©",
weights: "Ø±ÙØ¹ Ø£Ø«Ù‚Ø§Ù„",
time: "Ø§Ù„ÙˆÙ‚Øª",
distance: "Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)",
steps: "Ø§Ù„Ø®Ø·ÙˆØ§Øª",
start: "Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ…Ø±ÙŠÙ†",
stop: "Ø¥Ù†Ù‡Ø§Ø¡",
meal: "Ø§Ù„ÙˆØ¬Ø¨Ø©",
foodItem: "Ø§Ø³Ù… Ø§Ù„Ø·Ø¹Ø§Ù…",
calories: "Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©",
protein: "Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ† (Øº)",
carbs: "Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª (Øº)",
fats: "Ø§Ù„Ø¯Ù‡ÙˆÙ† (Øº)",
saveMeal: "Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø©",
age: "Ø§Ù„Ø¹Ù…Ø±",
weight: "Ø§Ù„ÙˆØ²Ù† (ÙƒØº)",
height: "Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)",
goal: "Ø§Ù„Ù‡Ø¯Ù",
saveProfile: "Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª",
logout: "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬",
breakfast: "ÙØ·ÙˆØ±",
lunch: "ØºØ¯Ø§Ø¡",
dinner: "Ø¹Ø´Ø§Ø¡",
snack: "ÙˆØ¬Ø¨Ø© Ø®ÙÙŠÙØ©",
lose: "Ø¥Ù†Ù‚Ø§Øµ Ø§Ù„ÙˆØ²Ù†",
gain: "Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¶Ù„Ø§Øª",
maintain: "Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ²Ù†",
gpsActive: "âœ… GPS Ù†Ø´Ø· â€” ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø³Ø§Ø±...",
gpsDenied: "âŒ Ù„Ù… ÙŠØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹",
gpsError: "âš ï¸ Ø®Ø·Ø£ ÙÙŠ GPS â€” Ø§Ù„ØªØªØ¨Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­",
stepTrackingReady: "ğŸš¶â€â™‚ï¸ Ø¬Ø§Ù‡Ø² Ù„Ø¹Ø¯Ù‘ Ø§Ù„Ø®Ø·ÙˆØ§Øª...",
calorieGoalLabel: "Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù…Ù† Ø§Ù„Ø³Ø¹Ø±Ø§Øª",
exportData: "ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (CSV)",
notificationOver: "âš ï¸ ØªØ¬Ø§ÙˆØ²Øª Ø³Ø¹Ø±Ø§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©!",
notificationInactive: "ğŸƒâ€â™‚ï¸ Ù„Ù… ØªØªÙ…Ø±Ù† Ø§Ù„ÙŠÙˆÙ…! Ù„Ø§ ØªÙÙˆØª ÙŠÙˆÙ…Ùƒ.",
darkMode: "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ",
lightMode: "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ"
},
en: {
appTitle: "FitTrack Pro",
username: "Username",
password: "Password",
signup: "Sign Up",
login: "Login",
dashboardTitle: "Analytical Dashboard",
caloriesBurned: "Calories Burned",
caloriesConsumed: "Calories Consumed",
netCalories: "Net Calories (Burned - Consumed)",
daysGoalMet: "Goal Days Met (Weekly)",
workoutsTitle: "Log Workout",
nutritionTitle: "Log Nutrition",
profileTitle: "Personal Profile",
walking: "Walking",
running: "Running",
cycling: "Cycling",
weights: "Weight Lifting",
time: "Time",
distance: "Distance (km)",
steps: "Steps",
start: "Start Workout",
stop: "Stop",
meal: "Meal",
foodItem: "Food Item",
calories: "Calories",
protein: "Protein (g)",
carbs: "Carbs (g)",
fats: "Fats (g)",
saveMeal: "Save Meal",
age: "Age",
weight: "Weight (kg)",
height: "Height (cm)",
goal: "Goal",
saveProfile: "Save Profile",
logout: "Logout",
breakfast: "Breakfast",
lunch: "Lunch",
dinner: "Dinner",
snack: "Snack",
lose: "Lose Weight",
gain: "Gain Muscle",
maintain: "Maintain Weight",
gpsActive: "âœ… GPS Active â€” Tracking...",
gpsDenied: "âŒ Location permission denied",
gpsError: "âš ï¸ GPS Error â€” Tracking unavailable",
stepTrackingReady: "ğŸš¶â€â™‚ï¸ Ready to count steps...",
calorieGoalLabel: "Daily Calorie Goal",
exportData: "Export Data (CSV)",
notificationOver: "âš ï¸ You exceeded your daily calories!",
notificationInactive: "ğŸƒâ€â™‚ï¸ You haven't worked out today! Don't miss your day.",
darkMode: "Dark Mode",
lightMode: "Light Mode"
}
};
let currentLang = 'ar';
let currentUser = null;
let workoutActive = false;
let startTime = null;
let timerInterval = null;
let distance = 0;
let stepCount = 0;
let lastPosition = null;
let watchId = null;
let positions = [];
let weeklyChart = null;
let syncInterval = null;
let dailyCalorieGoal = 2000;

// --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø© ---
let lastAccelMagnitude = 0;
let lastValleyTime = 0;
let lastStepTime = 0;
let isValleyDetected = false;
const STEP_THRESHOLD = 1.8;
const MIN_STEP_INTERVAL = 300;   // 300ms
const MAX_STEP_INTERVAL = 1500;  // 1500ms

// --- Ø¯Ø¹Ù… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ---
function initTheme() {
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
document.body.setAttribute('data-theme', 'dark');
}
}

// --- Firebase ---
const firebaseConfig = {
apiKey: "AIzaSyC1ps0XFVjJJ1YAi2H0XEtjAc-wslWrNjo",
authDomain: "ddccdc-c6a58.firebaseapp.com",
projectId: "ddccdc-c6a58",
storageBucket: "ddccdc-c6a58.firebasestorage.app",
messagingSenderId: "339966933373",
appId: "1:339966933373:web:b638ece3460e6c7a7c7414"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø°ÙƒÙŠØ© ---
function showNotification(message) {
if (Notification.permission === "granted") {
new Notification(message);
} else if (Notification.permission !== "denied") {
Notification.requestPermission().then(permission => {
if (permission === "granted") {
new Notification(message);
}
});
}
}

// --- ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
function exportData() {
db.collection('users').doc(currentUser.uid).collection('workouts').get()
.then(workoutsSnap => {
db.collection('users').doc(currentUser.uid).collection('nutrition').get()
.then(nutritionSnap => {
const data = [];
data.push(["Ø§Ù„ØªØ§Ø±ÙŠØ®", "Ø§Ù„Ù†ÙˆØ¹", "Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚ÙŠÙ‚Ø©)", "Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)", "Ø§Ù„Ø³Ø¹Ø±Ø§Øª", "Ø§Ù„Ø®Ø·ÙˆØ§Øª", "Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¬Ø¨Ø©", "Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ©"]);
// Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
const workoutMap = {};
workoutsSnap.forEach(doc => {
const w = doc.data();
workoutMap[w.date] = w;
});
const nutritionMap = {};
nutritionSnap.forEach(doc => {
const n = doc.data();
if (!nutritionMap[n.date]) nutritionMap[n.date] = [];
nutritionMap[n.date].push(n);
});
const allDates = new Set([
...Object.keys(workoutMap),
...Object.keys(nutritionMap)
]);
allDates.forEach(date => {
const w = workoutMap[date] || {};
const nList = nutritionMap[date] || [{ meal: "", calories: 0 }];
nList.forEach((n, i) => {
data.push([
date,
i === 0 ? w.type || "" : "",
i === 0 ? w.duration || "" : "",
i === 0 ? w.distance || "" : "",
i === 0 ? w.calories || "" : "",
i === 0 ? w.steps || "" : "",
n.meal,
n.calories
]);
});
});
// ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ CSV
const csv = data.map(row =>
row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(",")
).join("\n");
const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `fittrack_data_${new Date().toISOString().slice(0,10)}.csv`;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
});
});
}

// --- ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù†Ø´Ø§Ø· ---
function renderActivityCalendar() {
const container = document.getElementById('activityCalendar');
container.innerHTML = '';
const today = new Date();
// Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£ÙŠØ§Ù…
const days = currentLang === 'ar' ? ['Ø­', 'Ù†', 'Ø«', 'Ø±', 'Ø®', 'Ø¬', 'Ø³'] : ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
days.forEach(day => {
const dayEl = document.createElement('div');
dayEl.className = 'calendar-day';
dayEl.innerText = day;
dayEl.style.fontWeight = 'bold';
dayEl.style.color = 'var(--primary)';
container.appendChild(dayEl);
});
// Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ÙØ§Ø±ØºØ© Ù‚Ø¨Ù„ Ø§Ù„ÙŠÙˆÙ…
for (let i = 0; i < 13; i++) {
const date = new Date(today);
date.setDate(today.getDate() - (13 - i));
const dateStr = date.toISOString().split('T')[0];
const dayEl = document.createElement('div');
dayEl.className = 'calendar-day inactive';
dayEl.innerText = date.getDate();
container.appendChild(dayEl);
}
// Ø§Ù„ÙŠÙˆÙ…
const todayEl = document.createElement('div');
todayEl.className = 'calendar-day active';
todayEl.innerText = today.getDate();
container.appendChild(todayEl);
}

// --- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ ---
function updateCalorieProgress(consumed, goal) {
const percent = Math.min(100, (consumed / goal) * 100);
document.getElementById('calorieProgressBar').style.width = `${percent}%`;
document.getElementById('calorieProgressText').innerText = `${consumed}/${goal}`;
// ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¬Ø§ÙˆØ²
if (consumed > goal) {
showNotification(translations[currentLang].notificationOver);
}
}

// --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù„ØºØ© ---
function setLang(lang) {
currentLang = lang;
document.body.className = lang;
updateUI();
}
function updateUI() {
const t = translations[currentLang];
document.querySelector('.app-title').innerText = t.appTitle;
document.getElementById('usernameInput').placeholder = t.username;
document.getElementById('passwordInput').placeholder = t.password;
document.querySelector('.signup-btn').innerText = t.signup;
document.querySelector('.login-btn').innerText = t.login;
document.getElementById('inputGroup').className = `input-group${currentLang === 'en' ? ' en' : ''}`;
// Dashboard
document.getElementById('dashboardTitle').innerText = t.dashboardTitle;
document.getElementById('caloriesBurnedLabel').innerText = t.caloriesBurned;
document.getElementById('caloriesConsumedLabel').innerText = t.caloriesConsumed;
document.getElementById('netCaloriesLabel').innerText = t.netCalories;
document.getElementById('daysGoalMetLabel').innerText = t.daysGoalMet;
document.getElementById('calorieGoalLabel').innerText = t.calorieGoalLabel;
document.querySelector('.export-btn').innerText = t.exportData;
// Workouts
document.getElementById('workoutsTitle').innerText = t.workoutsTitle;
const act = document.getElementById('activityType');
if (act) {
act.options[0].text = t.walking;
act.options[1].text = t.running;
act.options[2].text = t.cycling;
act.options[3].text = t.weights;
document.getElementById('timeLabel').innerText = t.time;
document.getElementById('distanceLabel').innerText = t.distance;
document.getElementById('stepCountLabel').innerText = t.steps;
document.getElementById('startBtn').innerText = t.start;
document.getElementById('stopBtn').innerText = t.stop;
}
// Nutrition
document.getElementById('nutritionTitle').innerText = t.nutritionTitle;
document.getElementById('mealLabel').innerText = t.meal;
document.getElementById('foodItem').placeholder = t.foodItem;
document.getElementById('caloriesInput').placeholder = t.calories;
document.getElementById('proteinInput').placeholder = t.protein;
document.getElementById('carbsInput').placeholder = t.carbs;
document.getElementById('fatsInput').placeholder = t.fats;
document.querySelector('button[onclick="saveNutrition()"]').innerText = t.saveMeal;
const mealSel = document.getElementById('mealType');
if (mealSel) {
mealSel.options[0].text = t.breakfast;
mealSel.options[1].text = t.lunch;
mealSel.options[2].text = t.dinner;
mealSel.options[3].text = t.snack;
}
// Profile
document.getElementById('profileTitle').innerText = t.profileTitle;
document.getElementById('ageLabel').innerText = t.age;
document.getElementById('weightLabel').innerText = t.weight;
document.getElementById('heightLabel').innerText = t.height;
document.getElementById('goalLabel').innerText = t.goal;
document.querySelector('button[onclick="saveProfile()"]').innerText = t.saveProfile;
const goalSel = document.getElementById('goalInput');
if (goalSel) {
goalSel.options[0].text = t.lose;
goalSel.options[1].text = t.gain;
goalSel.options[2].text = t.maintain;
}
// GPS
if (document.getElementById('gpsStatus')) {
const lastMsg = document.getElementById('gpsStatus').innerText;
if (lastMsg.includes('âœ…') || lastMsg.includes('âŒ') || lastMsg.includes('âš ï¸')) {
// Ù„Ø§ ØªØºÙŠÙ‘Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¹Ø±Ø¶ Ø­Ø§Ù„Ø© GPS
}
}
}

// --- Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª ---
function showTab(tabName) {
document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
document.querySelectorAll('.nav-icon').forEach(el => el.classList.remove('active'));
document.getElementById(tabName + 'Tab').classList.remove('hidden');
document.querySelector(`.nav-icon[data-tab="${tabName}"]`).classList.add('active');
if (tabName === 'dashboard' && currentUser) {
loadDashboard();
startAutoSync();
}
if (tabName === 'nutrition' && currentUser) loadNutritionList();
if (tabName === 'profile' && currentUser) loadProfile();
}
document.querySelectorAll('.nav-icon').forEach(icon => {
icon.addEventListener('click', () => {
showTab(icon.getAttribute('data-tab'));
});
});

// --- Auth ---
function handleAuth(isSignup) {
const username = document.getElementById('usernameInput').value.trim();
const password = document.getElementById('passwordInput').value;
if (!username || password.length < 6) return alert('Password too short (min 6)');
const email = `${username}@example.com`;
(isSignup ?
auth.createUserWithEmailAndPassword(email, password) :
auth.signInWithEmailAndPassword(email, password)
)
.then(async (userCredential) => {
if (isSignup) {
await userCredential.user.updateProfile({ displayName: username });
await db.collection('users').doc(userCredential.user.uid).set({
username,
createdAt: firebase.firestore.FieldValue.serverTimestamp()
});
}
currentUser = userCredential.user;
document.getElementById('preAuthSection').classList.add('hidden');
document.getElementById('topNav').classList.remove('hidden');
document.getElementById('appSection').classList.remove('hidden');
updateUI();
showTab('dashboard');
})
.catch(err => {
alert('Error: ' + err.message);
});
}
function logout() {
auth.signOut().then(() => {
currentUser = null;
document.getElementById('preAuthSection').classList.remove('hidden');
document.getElementById('topNav').classList.add('hidden');
document.getElementById('appSection').classList.add('hidden');
document.getElementById('usernameInput').value = '';
document.getElementById('passwordInput').value = '';
if (syncInterval) clearInterval(syncInterval);
});
}

// --- GPS & Workouts ---
function haversineDistance(lat1, lon1, lat2, lon2) {
const R = 6371;
const dLat = (lat2 - lat1) * Math.PI / 180;
const dLon = (lon2 - lon1) * Math.PI / 180;
const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
Math.sin(dLon/2) * Math.sin(dLon/2);
const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
return R * c;
}

// === âœ… Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø¹Ø¯Ù‘ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø© (Peak-Valley) ===
function handleStep(event) {
  if (!workoutActive) return;
  const acc = event.accelerationIncludingGravity;
  if (!acc) return;

  const now = Date.now();
  const accelMag = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);
  const delta = accelMag - lastAccelMagnitude;
  lastAccelMagnitude = accelMag;

  // Ø§ÙƒØªØ´Ø§Ù "Ø§Ù†Ø®ÙØ§Ø¶" (valley)
  if (delta < -0.8 && accelMag < 9.0) {
    lastValleyTime = now;
    isValleyDetected = true;
  }

  // Ø§ÙƒØªØ´Ø§Ù "Ø°Ø±ÙˆØ©" (peak) Ø¨Ø¹Ø¯ Ø§Ù†Ø®ÙØ§Ø¶
  if (Math.abs(delta) > STEP_THRESHOLD) {
    if (isValleyDetected && (now - lastValleyTime) < 800) {
      if ((now - lastStepTime) > MIN_STEP_INTERVAL && (now - lastStepTime) < MAX_STEP_INTERVAL) {
        stepCount++;
        lastStepTime = now;
        isValleyDetected = false;
        document.getElementById('stepCountDisplay').innerText = stepCount;
        const statusEl = document.getElementById('gpsStatus');
        if (statusEl) {
          statusEl.innerText = `ğŸ“ ${distance.toFixed(2)} ÙƒÙ… | ğŸš¶â€â™‚ï¸ ${stepCount} Ø®Ø·ÙˆØ©`;
        }
      }
    }
  }
}

function startStepTracking() {
  if (typeof DeviceMotionEvent === 'undefined') return;
  if (typeof DeviceMotionEvent.requestPermission === 'function') {
    DeviceMotionEvent.requestPermission().then(permission => {
      if (permission === 'granted') {
        window.addEventListener('devicemotion', handleStep);
      }
    }).catch(() => {});
  } else {
    window.addEventListener('devicemotion', handleStep);
  }
}

// === âœ… ØªØ­Ø³ÙŠÙ† GPS Ù…Ø¹ ÙÙ„ØªØ±Ø© ===
function startGPS() {
  if (!navigator.geolocation) {
    document.getElementById('gpsStatus').innerText = translations[currentLang].gpsError;
    return;
  }
  if (watchId) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition(
    (position) => {
      const accuracy = position.coords.accuracy;
      const speed = position.coords.speed || 0;
      const { latitude, longitude } = position.coords;

      // ÙÙ„ØªØ±Ø© 1: ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ù…Ù†Ø®ÙØ¶Ø©
      if (accuracy > 20) return;

      // ÙÙ„ØªØ±Ø© 2: ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù‚ÙØ²Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ©
      if (lastPosition) {
        const d = haversineDistance(lastPosition.lat, lastPosition.lng, latitude, longitude);
        const timeDiff = (new Date().getTime() - lastPosition.time) / 1000;
        if (timeDiff > 0) {
          const calcSpeed = (d * 1000) / timeDiff; // Ù…/Ø«
          if (calcSpeed > 4.2) return; // > 15 ÙƒÙ…/Ø³
        }
      }

      document.getElementById('gpsStatus').innerText = translations[currentLang].gpsActive;
      if (lastPosition) {
        const d = haversineDistance(lastPosition.lat, lastPosition.lng, latitude, longitude);
        distance += d;
        document.getElementById('distanceDisplay').innerText = distance.toFixed(2);
      }
      lastPosition = { lat: latitude, lng: longitude, time: new Date().getTime() };
      positions.push({ lat: latitude, lng: longitude, time: new Date().toISOString() });
    },
    (error) => {
      let msg = translations[currentLang].gpsError;
      if (error.code === 1) msg = translations[currentLang].gpsDenied;
      document.getElementById('gpsStatus').innerText = msg;
    },
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
}

function onActivityChange() {
  const selectedActivity = document.getElementById('activityType').value;
  const isGpsNeeded = ['walking', 'running', 'cycling'].includes(selectedActivity);
  const gpsSection = document.getElementById('gpsSection');
  
  if (isGpsNeeded) {
    gpsSection.classList.remove('hidden');
    document.getElementById('gpsStatus').innerText = "Ø¬Ø§Ø±Ù ØªÙØ¹ÙŠÙ„ GPS ÙˆØ§Ù„Ø­Ø³Ø§Ø³...";
    startGPS();
    if (['walking', 'running'].includes(selectedActivity)) {
      startStepTracking();
    }
  } else {
    gpsSection.classList.add('hidden');
    if (watchId) navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
}

function startWorkout() {
  const selectedActivity = document.getElementById('activityType').value;
  workoutActive = true;
  startTime = Date.now();
  distance = 0;
  stepCount = 0;
  lastPosition = null;
  positions = [];
  lastAccelMagnitude = 0;
  lastValleyTime = 0;
  lastStepTime = 0;
  isValleyDetected = false;

  document.getElementById('distanceDisplay').innerText = '0.00';
  document.getElementById('stepCountDisplay').innerText = '0';
  document.getElementById('startBtn').classList.add('hidden');
  document.getElementById('stopBtn').classList.remove('hidden');

  timerInterval = setInterval(() => {
    const elapsed = Date.now() - startTime;
    const mins = Math.floor(elapsed / 60000);
    const secs = Math.floor((elapsed % 60000) / 1000);
    document.getElementById('timeDisplay').innerText =
    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }, 1000);
}

function stopWorkout() {
  workoutActive = false;
  clearInterval(timerInterval);
  if (watchId) navigator.geolocation.clearWatch(watchId);
  window.removeEventListener('devicemotion', handleStep);

  const duration = Math.round((Date.now() - startTime) / 1000 / 60);
  // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ³Ø¬Ù„ GPS Ù…Ø³Ø§ÙØ©ØŒ Ù†Ø­Ø³Ø¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ø®Ø·ÙˆØ§Øª (PDR)
  const finalDistance = distance > 0 ? distance : (stepCount * 0.75 / 1000); // 0.75 Ù…ØªØ±/Ø®Ø·ÙˆØ©
  const calories = Math.round(finalDistance * 60);

  db.collection('users').doc(currentUser.uid).collection('workouts').add({
    type: document.getElementById('activityType').value,
    duration,
    distance: parseFloat(finalDistance.toFixed(2)),
    calories,
    steps: stepCount,
    date: new Date().toISOString().split('T')[0],
    positions,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    document.getElementById('startBtn').classList.remove('hidden');
    document.getElementById('stopBtn').classList.add('hidden');
    distance = 0;
    lastPosition = null;
    stepCount = 0;
    loadDashboard();
  });
}

// --- Ø§Ù„ØªØºØ°ÙŠØ© ---
function saveNutrition() {
  const food = document.getElementById('foodItem').value.trim();
  const calories = parseFloat(document.getElementById('caloriesInput').value) || 0;
  const protein = parseFloat(document.getElementById('proteinInput').value) || 0;
  const carbs = parseFloat(document.getElementById('carbsInput').value) || 0;
  const fats = parseFloat(document.getElementById('fatsInput').value) || 0;
  const meal = document.getElementById('mealType').value;
  if (!food) return alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø¹Ø§Ù…');
  db.collection('users').doc(currentUser.uid).collection('nutrition').add({
    food,
    calories,
    protein,
    carbs,
    fats,
    meal,
    date: new Date().toISOString().split('T')[0],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    loadNutritionList();
    document.getElementById('foodItem').value = '';
    document.getElementById('caloriesInput').value = '';
    document.getElementById('proteinInput').value = '';
    document.getElementById('carbsInput').value = '';
    document.getElementById('fatsInput').value = '';
  });
}
function loadNutritionList() {
  const container = document.getElementById('nutritionList');
  container.innerHTML = '<p>Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';
  const today = new Date().toISOString().split('T')[0];
  db.collection('users').doc(currentUser.uid).collection('nutrition')
  .get()
  .then(snapshot => {
    container.innerHTML = '<h4>Ø§Ù„ÙŠÙˆÙ…:</h4>';
    let hasData = false;
    snapshot.forEach(doc => {
      const n = doc.data();
      if (n.date === today) {
        hasData = true;
        container.innerHTML += `<div style="padding: 8px; border-bottom: 1px solid #eee;">
        <strong>${n.food}</strong> (${n.meal})<br>
        ${n.calories} Ø³Ø¹Ø±Ø© Ø­Ø±Ø§Ø±ÙŠØ©
        </div>`;
      }
    });
    if (!hasData) {
      container.innerHTML += '<p>Ù„Ù… ØªÙØ³Ø¬Ù‘Ù„ Ø£ÙŠ ÙˆØ¬Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ….</p>';
    }
  });
}

// --- Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ---
function saveProfile() {
  const age = parseInt(document.getElementById('ageInput').value);
  const weight = parseFloat(document.getElementById('weightInput').value);
  const height = parseInt(document.getElementById('heightInput').value);
  const goal = document.getElementById('goalInput').value;
  const calorieGoal = parseInt(document.getElementById('calorieGoalInput').value) || 2000;
  if (!age || !weight || !height) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª');
  db.collection('users').doc(currentUser.uid).set({
    age, weight, height, goal, calorieGoal,
    username: currentUser.displayName,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true })
  .then(() => {
    dailyCalorieGoal = calorieGoal;
    alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
    loadDashboard();
  });
}
function loadProfile() {
  db.collection('users').doc(currentUser.uid).get().then(doc => {
    if (doc.exists) {
      const data = doc.data();
      document.getElementById('ageInput').value = data.age || '';
      document.getElementById('weightInput').value = data.weight || '';
      document.getElementById('heightInput').value = data.height || '';
      document.getElementById('goalInput').value = data.goal || 'maintain';
      document.getElementById('calorieGoalInput').value = data.calorieGoal || 2000;
      dailyCalorieGoal = data.calorieGoal || 2000;
      document.getElementById('userInfo').innerText = `${translations[currentLang].appTitle} â€” ${data.username}`;
    }
  });
}

// --- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ---
function loadDashboard() {
  const today = new Date().toISOString().split('T')[0];
  const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
  Promise.all([
    db.collection('users').doc(currentUser.uid).collection('workouts').get(),
    db.collection('users').doc(currentUser.uid).collection('nutrition').get(),
    db.collection('users').doc(currentUser.uid).get()
  ]).then(([workoutsSnap, nutritionSnap, userDoc]) => {
    const userData = userDoc.data();
    dailyCalorieGoal = userData?.calorieGoal || 2000;
    let burned = 0, consumed = 0;
    workoutsSnap.forEach(doc => {
      const w = doc.data();
      if (w.date === today) burned += w.calories || 0;
    });
    nutritionSnap.forEach(doc => {
      const n = doc.data();
      if (n.date === today) consumed += n.calories || 0;
    });
    document.getElementById('caloriesBurned').innerText = burned;
    document.getElementById('caloriesConsumed').innerText = consumed;
    document.getElementById('netCalories').innerText = (burned - consumed);
    updateCalorieProgress(consumed, dailyCalorieGoal);
    renderActivityCalendar();
    const labels = [], burnedData = [], consumedData = [];
    for (let i = 6; i >= 0; i--) {
      const d = new Date(Date.now() - i * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      labels.push(d);
      burnedData.push(0);
      consumedData.push(0);
    }
    workoutsSnap.forEach(doc => {
      const w = doc.data();
      if (w.date >= weekAgo) {
        const idx = labels.indexOf(w.date);
        if (idx >= 0) burnedData[idx] += w.calories || 0;
      }
    });
    nutritionSnap.forEach(doc => {
      const n = doc.data();
      if (n.date >= weekAgo) {
        const idx = labels.indexOf(n.date);
        if (idx >= 0) consumedData[idx] += n.calories || 0;
      }
    });
    const ctx = document.getElementById('weeklyChart').getContext('2d');
    if (weeklyChart) weeklyChart.destroy();
    weeklyChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: currentLang === 'ar' ? 'Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø±ÙˆÙ‚Ø©' : 'Calories Burned',
            data: burnedData,
            backgroundColor: 'rgba(67, 97, 238, 0.6)'
          },
          {
            label: currentLang === 'ar' ? 'Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©' : 'Calories Consumed',
            data: consumedData,
            backgroundColor: 'rgba(239, 68, 68, 0.6)'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } }
      }
    });
    const hasWorkoutToday = workoutsSnap.docs.some(doc => doc.data().date === today);
    if (!hasWorkoutToday && new Date().getHours() > 18) {
      showNotification(translations[currentLang].notificationInactive);
    }
  });
}

// --- Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ---
function startAutoSync() {
  if (syncInterval) clearInterval(syncInterval);
  syncInterval = setInterval(() => {
    if (document.getElementById('dashboardTab').classList.contains('hidden')) return;
    loadDashboard();
  }, 30000);
}

// --- ØªÙ‡ÙŠØ¦Ø© ---
initTheme();
updateUI();
</script>
</body>
</html>
